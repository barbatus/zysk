{"version":3,"file":"browser.js","sourceRoot":"","sources":["browser.ts"],"names":[],"mappings":";;;;;;AAwEA,4CAYC;AAsDD,0CA4CC;AA8FD,gCAuDC;AA3UD,6CAA2C;AAQ3C,sEAAwC;AACxC,wGAA+D;AAC/D,oGAA2D;AAC3D,wDAAuC;AAEvC,qCAA8C;AAE9C,MAAM,kBAAkB,GAAG;IACzB,iBAAiB;IACjB,sBAAsB;IACtB,uBAAuB;IACvB,uBAAuB;IACvB,sBAAsB;IACtB,sBAAsB;IACtB,cAAc;IACd,eAAe;IACf,WAAW;IACX,iBAAiB;IACjB,cAAc;IACd,WAAW;IACX,qBAAqB;CACtB,CAAC;AAEF,MAAM,gBAAgB,GAAG;IACvB,KAAK;IACL,KAAK;IACL,MAAM;IACN,KAAK;IACL,KAAK;IACL,KAAK;IACL,KAAK;IACL,KAAK;IACL,MAAM;IACN,KAAK;IACL,KAAK;IACL,MAAM;IACN,KAAK;CACN,CAAC;AAEF,MAAa,aAAc,SAAQ,KAAK;IAE7B;IADT,YACS,MAAc,EACrB,OAAe;QAEf,KAAK,CAAC,OAAO,CAAC,CAAC;QAHR,WAAM,GAAN,MAAM,CAAQ;IAIvB,CAAC;CACF;AAPD,sCAOC;AAED,MAAM,MAAM,GAAG,IAAA,2BAAkB,GAAE,CAAC;AACpC,MAAM,QAAQ,GAAG,IAAI,kBAAe,EAAE,CAAC;AACvC,QAAQ,CAAC,OAAO,CAAC,aAAa,EAAE;IAC9B,MAAM,EAAE,CAAC,GAAG,CAAC;IACb,WAAW,CAAC,OAAO;QACjB,OAAO,OAAO,CAAC;IACjB,CAAC;CACF,CAAC,CAAC;AAEH,QAAQ,CAAC,OAAO,CAAC,SAAS,EAAE;IAC1B,MAAM,EAAE,CAAC,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,OAAO,EAAE,IAAI,CAAC;IAChD,WAAW;QACT,OAAO,EAAE,CAAC;IACZ,CAAC;CACF,CAAC,CAAC;AAEI,KAAK,UAAU,gBAAgB,CAAC,OAAgB;IACrD,IAAI,CAAC;QACH,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE,CAAC;YACvB,OAAO,KAAK,CAAC;QACf,CAAC;QACD,MAAM,OAAO,CAAC,OAAO,EAAE,CAAC;QACxB,OAAO,IAAI,CAAC;IACd,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,OAAO,CAAC,IAAI,CAAC,8BAA8B,EAAE,KAAK,CAAC,CAAC;QACpD,MAAM,OAAO,CAAC,KAAK,EAAE,CAAC;QACtB,OAAO,KAAK,CAAC;IACf,CAAC;AACH,CAAC;AAED,KAAK,UAAU,UAAU,CAAC,MAIzB;IACC,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,CAAC;IAE3B,yBAAS,CAAC,GAAG,CAAC,IAAA,wCAAa,GAAE,CAAC,CAAC;IAC/B,yBAAS,CAAC,GAAG,CACX,IAAA,0CAAe,EAAC;QACd,QAAQ,EAAE;YACR,EAAE,EAAE,UAAU;YACd,KAAK,EAAE,MAAM,CAAC,YAAY;SAC3B;QACD,cAAc,EAAE,IAAI;KACrB,CAAC,CACH,CAAC;IACF,MAAM,MAAM,GAAG,MAAM,yBAAS,CAAC,MAAM,CAAC;QACpC,QAAQ,EAAE,IAAI;QACd,eAAe,EAAE,OAAO;QACxB,IAAI,EAAE;YACJ,cAAc;YACd,0BAA0B;YAC1B,yBAAyB;YACzB,iCAAiC;YACjC,gBAAgB;YAChB,aAAa;YACb,eAAe;YACf,+BAA+B;YAC/B,cAAc;SACf;KACF,CAAC,CAAC;IACH,OAAO,MAAM,CAAC;AAChB,CAAC;AAED,KAAK,UAAU,iBAAiB,CAAC,MAA8B;IAC7D,MAAM,aAAa,GAAG,CAAC,OAAgB,EAAE,EAAE;QACzC,OAAO,OAAO,CAAC,oBAAoB,CAAC;YAClC,WAAW,EAAE,QAAQ;gBACnB,CAAC,CAAC,GAAG,MAAM,CAAC,WAAW,IAAI,MAAM,CAAC,SAAS,EAAE;gBAC7C,CAAC,CAAC,SAAS;SACd,CAAC,CAAC;IACL,CAAC,CAAC;IAEF,MAAM,OAAO,GAAG,MAAM,UAAU,CAAC,EAAE,CAAC,CAAC;IACrC,MAAM,EAAE,QAAQ,GAAG,IAAI,EAAE,GAAG,MAAM,CAAC;IACnC,OAAO;QACL,OAAO,EAAE,MAAM,aAAa,CAAC,OAAO,CAAC;QACrC,OAAO;KACR,CAAC;AACJ,CAAC;AAEM,KAAK,UAAU,eAAe,CAAC,MAGrC;IACC,MAAM,EAAE,OAAO,EAAE,KAAK,EAAE,GAAG,MAAM,CAAC;IAElC,MAAM,UAAU,GAAG,KAAK,IAAI,EAAE;QAC5B,MAAM,IAAI,GAAG,MAAM,OAAO,CAAC,OAAO,EAAE,CAAC;QAErC,MAAM,IAAI,CAAC,sBAAsB,CAAC,IAAI,CAAC,CAAC;QACxC,IAAI,CAAC,EAAE,CAAC,SAAS,EAAE,CAAC,OAAO,EAAE,EAAE;YAC7B,MAAM,UAAU,GAAG,OAAO,CAAC,GAAG,EAAE,CAAC;YACjC,MAAM,OAAO,GAAG,gBAAgB,CAAC,IAAI,CAAC,CAAC,GAAG,EAAE,EAAE,CAC5C,UAAU,CAAC,QAAQ,CAAC,IAAI,GAAG,EAAE,CAAC,CAC/B,CAAC;YACF,MAAM,IAAI,GAAG,kBAAkB,CAAC,IAAI,CAAC,CAAC,MAAM,EAAE,EAAE,CAC9C,UAAU,CAAC,QAAQ,CAAC,MAAM,CAAC,CAC5B,CAAC;YACF,IAAI,OAAO,IAAI,IAAI,EAAE,CAAC;gBACpB,KAAK,OAAO,CAAC,KAAK,EAAE,CAAC;YACvB,CAAC;iBAAM,CAAC;gBACN,KAAK,OAAO,CAAC,QAAQ,EAAE,CAAC;YAC1B,CAAC;QACH,CAAC,CAAC,CAAC;QAEH,MAAM,IAAI,CAAC,YAAY,CAAC;YACtB,QAAQ,EAAE,MAAM,CAAC,aAAc;YAC/B,QAAQ,EAAE,MAAM,CAAC,aAAc;SAChC,CAAC,CAAC;QAEH,MAAM,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACrC,IAAI,CAAC,2BAA2B,CAAC,OAAO,CAAC,CAAC;QAC1C,IAAI,CAAC,IAAI,GAAG,KAAK,EAAE,GAAG,EAAE,OAAO,EAAE,EAAE;YACjC,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC;YAC3C,MAAM,IAAI,CAAC,eAAe,EAAE,CAAC;YAC7B,OAAO,MAAM,CAAC;QAChB,CAAC,CAAC;QAEF,OAAO,IAAI,CAAC;IACd,CAAC,CAAC;IAEF,OAAO;QACL,KAAK,EAAE,MAAM,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,KAAK,EAAE,EAAE,UAAU,CAAC,CAAC;KACpE,CAAC;AACJ,CAAC;AAED,KAAK,UAAU,KAAK,CAAC,EAAU;IAC7B,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE;QAC7B,UAAU,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC;IAC1B,CAAC,CAAC,CAAC;AACL,CAAC;AAED,MAAM,MAAM,GAAG,IAAA,oBAAS,GAAE,CAAC;AAE3B,KAAK,UAAU,SAAS,CAAC,MAMxB;IACC,MAAM,EAAE,GAAG,EAAE,IAAI,EAAE,OAAO,EAAE,OAAO,EAAE,WAAW,EAAE,GAAG,MAAM,CAAC;IAC5D,IAAI,QAA6B,CAAC;IAElC,MAAM,SAAS,GAAG,KAAK,IAAI,EAAE;QAC3B,IAAI,CAAC;YACH,QAAQ,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE;gBAC9B,SAAS,EAAE,kBAAkB;gBAC7B,OAAO;aACR,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IACG,KAAe,CAAC,OAAO,CAAC,QAAQ,CAAC,eAAe,CAAC;gBACjD,KAAe,CAAC,OAAO,CAAC,QAAQ,CAAC,qBAAqB,CAAC;gBACvD,KAAe,CAAC,OAAO,CAAC,QAAQ,CAAC,0BAA0B,CAAC;gBAC5D,KAAwB,CAAC,IAAI,KAAK,cAAc,EACjD,CAAC;gBACD,MAAM,IAAI,aAAa,CAAC,GAAG,EAAG,KAAe,CAAC,OAAO,CAAC,CAAC;YACzD,CAAC;YACD,MAAM,KAAK,CAAC;QACd,CAAC;QAED,MAAM,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE;YAC5B,UAAU,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;QAC/B,CAAC,CAAC,CAAC;QAEH,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,OAAO,EAAE,CAAC;QACrC,IAAI,QAAS,CAAC,MAAM,EAAE,KAAK,GAAG,EAAE,CAAC;YAC/B,MAAM,IAAI,aAAa,CAAC,QAAS,CAAC,MAAM,EAAE,EAAE,qBAAqB,CAAC,CAAC;QACrE,CAAC;QAED,MAAM,QAAQ,GAAG,QAAS,CAAC,GAAG,EAAE,CAAC;QAEjC,MAAM,CAAC,IAAI,CACT;YACE,QAAQ;SACT,EACD,0BAA0B,CAC3B,CAAC;QAEF,IAAI,WAAW,EAAE,CAAC;YAChB,OAAO,EAAE,OAAO,EAAE,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,EAAE,GAAG,EAAE,QAAQ,EAAE,CAAC;QAChE,CAAC;QAED,OAAO,EAAE,OAAO,EAAE,GAAG,EAAE,QAAQ,EAAE,CAAC;IACpC,CAAC,CAAC;IAEF,IAAI,KAAK,GAAG,CAAC,CAAC;IACd,OAAO,KAAK,GAAG,CAAC,EAAE,CAAC;QACjB,IAAI,CAAC;YACH,OAAO,MAAM,SAAS,EAAE,CAAC;QAC3B,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IACE,KAAK,YAAY,aAAa;gBAC9B,CAAC,KAAK,CAAC,MAAM,KAAK,GAAG;oBACnB,KAAK,CAAC,MAAM,KAAK,GAAG;oBACpB,KAAK,CAAC,MAAM,KAAK,GAAG;oBACpB,KAAK,CAAC,MAAM,KAAK,GAAG,CAAC,EACvB,CAAC;gBACD,KAAK,EAAE,CAAC;gBACR,MAAM,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,KAAK,GAAG,CAAC,CAAC,GAAG,MAAM,CAAC;gBAC3C,MAAM,CAAC,IAAI,CACT;oBACE,GAAG;oBACH,MAAM,EAAE,KAAK,CAAC,MAAM;iBACrB,EACD,oCAAoC,IAAI,CAAC,KAAK,CAAC,EAAE,GAAG,IAAI,CAAC,UAAU,CACpE,CAAC;gBACF,MAAM,KAAK,CAAC,EAAE,CAAC,CAAC;gBAChB,SAAS;YACX,CAAC;YACD,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED,MAAM,IAAI,aAAa,CAAC,GAAG,EAAE,qBAAqB,CAAC,CAAC;AACtD,CAAC;AAEM,KAAK,UAAU,UAAU,CAAC,MAOhC;IAOC,MAAM,EACJ,IAAI,EACJ,OAAO,GAAG,IAAI,EACd,OAAO,GAAG,OAAO,EACjB,WAAW,GAAG,IAAI,EAClB,QAAQ,GAAG,IAAI,GAChB,GAAG,MAAM,CAAC;IAEX,MAAM,EAAE,OAAO,EAAE,OAAO,EAAE,GAAG,MAAM,iBAAiB,CAAC;QACnD,QAAQ;KACT,CAAC,CAAC;IAEH,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,eAAe,CAAC;QACtC,KAAK,EAAE,IAAI,CAAC,MAAM;QAClB,OAAO;KACR,CAAC,CAAC;IAEH,MAAM,OAAO,GAAG,MAAM,OAAO,CAAC,UAAU,CACtC,KAAK,CAAC,GAAG,CAAC,KAAK,EAAE,IAAI,EAAE,KAAK,EAAE,EAAE;QAC9B,MAAM,EAAE,OAAO,EAAE,GAAG,EAAE,GAAG,MAAM,SAAS,CAAC;YACvC,GAAG,EAAE,IAAI,CAAC,KAAK,CAAC;YAChB,IAAI;YACJ,OAAO;YACP,OAAO;YACP,WAAW;SACZ,CAAC,CAAC;QACH,OAAO,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;IAC1B,CAAC,CAAC,CACH,CAAC;IAEF,MAAM,OAAO,CAAC,KAAK,EAAE,CAAC;IAEtB,OAAO,OAAO,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,KAAK,EAAE,EAAE;QACnC,IAAI,MAAM,CAAC,MAAM,KAAK,WAAW,EAAE,CAAC;YAClC,OAAO,MAAM,CAAC,KAAK,CAAC;QACtB,CAAC;QACD,OAAO;YACL,GAAG,EAAE,IAAI,CAAC,KAAK,CAAC;YAChB,KAAK,EAAE,MAAM,CAAC,MAAe;SAC9B,CAAC;IACJ,CAAC,CAAC,CAAC;AACL,CAAC","sourcesContent":["import { getLogger } from \"@zysk/services\";\nimport {\n  type Browser,\n  type BrowserContext,\n  type HTTPResponse,\n  type Page,\n  type PuppeteerError,\n} from \"puppeteer\";\nimport puppeteer from \"puppeteer-extra\";\nimport RecaptchaPlugin from \"puppeteer-extra-plugin-recaptcha\";\nimport StealthPlugin from \"puppeteer-extra-plugin-stealth\";\nimport TurndownService from \"turndown\";\n\nimport { getAppConfigStatic } from \"./config\";\n\nconst AD_SERVING_DOMAINS = [\n  \"doubleclick.net\",\n  \"adservice.google.com\",\n  \"googlesyndication.com\",\n  \"googletagservices.com\",\n  \"googletagmanager.com\",\n  \"google-analytics.com\",\n  \"adsystem.com\",\n  \"adservice.com\",\n  \"adnxs.com\",\n  \"ads-twitter.com\",\n  \"facebook.net\",\n  \"fbcdn.net\",\n  \"amazon-adsystem.com\",\n];\n\nconst MEDIA_EXTENSIONS = [\n  \"png\",\n  \"jpg\",\n  \"jpeg\",\n  \"gif\",\n  \"svg\",\n  \"mp3\",\n  \"mp4\",\n  \"avi\",\n  \"flac\",\n  \"ogg\",\n  \"wav\",\n  \"webm\",\n  \"css\",\n];\n\nexport class PageLoadError extends Error {\n  constructor(\n    public status: number,\n    message: string,\n  ) {\n    super(message);\n  }\n}\n\nconst config = getAppConfigStatic();\nconst turndown = new TurndownService();\nturndown.addRule(\"removeLinks\", {\n  filter: [\"a\"],\n  replacement(content) {\n    return content;\n  },\n});\n\nturndown.addRule(\"cleanup\", {\n  filter: [\"link\", \"img\", \"script\", \"style\", \"ul\"],\n  replacement() {\n    return \"\";\n  },\n});\n\nexport async function isBrowserHealthy(browser: Browser): Promise<boolean> {\n  try {\n    if (!browser.connected) {\n      return false;\n    }\n    await browser.version();\n    return true;\n  } catch (error) {\n    console.warn(\"Browser health check failed:\", error);\n    await browser.close();\n    return false;\n  }\n}\n\nasync function newBrowser(params: {\n  useBrowserApi?: boolean;\n  useProxy?: boolean;\n  timeout?: number;\n}) {\n  const { timeout } = params;\n\n  puppeteer.use(StealthPlugin());\n  puppeteer.use(\n    RecaptchaPlugin({\n      provider: {\n        id: \"2captcha\",\n        token: config.captchaToken,\n      },\n      visualFeedback: true,\n    }),\n  );\n  const chrome = await puppeteer.launch({\n    headless: true,\n    protocolTimeout: timeout,\n    args: [\n      \"--no-sandbox\",\n      \"--disable-setuid-sandbox\",\n      \"--disable-dev-shm-usage\",\n      \"--disable-accelerated-2d-canvas\",\n      \"--no-first-run\",\n      \"--no-zygote\",\n      \"--disable-gpu\",\n      \"--disable-software-rasterizer\",\n      \"--mute-audio\",\n    ],\n  });\n  return chrome;\n}\n\nasync function newBrowserContext(params: { useProxy?: boolean }) {\n  const createContext = (browser: Browser) => {\n    return browser.createBrowserContext({\n      proxyServer: useProxy\n        ? `${config.proxyServer}:${config.proxyPort}`\n        : undefined,\n    });\n  };\n\n  const browser = await newBrowser({});\n  const { useProxy = true } = params;\n  return {\n    context: await createContext(browser),\n    browser,\n  };\n}\n\nexport async function newBrowserPages(params: {\n  pages: number;\n  context: BrowserContext;\n}) {\n  const { context, pages } = params;\n\n  const createPage = async () => {\n    const page = await context.newPage();\n\n    await page.setRequestInterception(true);\n    page.on(\"request\", (request) => {\n      const requestUrl = request.url();\n      const isMedia = MEDIA_EXTENSIONS.some((ext) =>\n        requestUrl.endsWith(`.${ext}`),\n      );\n      const isAd = AD_SERVING_DOMAINS.some((domain) =>\n        requestUrl.includes(domain),\n      );\n      if (isMedia || isAd) {\n        void request.abort();\n      } else {\n        void request.continue();\n      }\n    });\n\n    await page.authenticate({\n      username: config.proxyUsername!,\n      password: config.proxyPassword!,\n    });\n\n    const oldGoTo = page.goto.bind(page);\n    page.setDefaultNavigationTimeout(180_000);\n    page.goto = async (url, options) => {\n      const result = await oldGoTo(url, options);\n      await page.solveRecaptchas();\n      return result;\n    };\n\n    return page;\n  };\n\n  return {\n    pages: await Promise.all(Array.from({ length: pages }, createPage)),\n  };\n}\n\nasync function sleep(ms: number) {\n  return new Promise((resolve) => {\n    setTimeout(resolve, ms);\n  });\n}\n\nconst logger = getLogger();\n\nasync function scrapeUrl(params: {\n  url: string;\n  page: Page;\n  timeout: number;\n  waitFor: number;\n  convertToMd: boolean;\n}) {\n  const { url, page, timeout, waitFor, convertToMd } = params;\n  let response: HTTPResponse | null;\n\n  const visitPage = async () => {\n    try {\n      response = await page.goto(url, {\n        waitUntil: \"domcontentloaded\",\n        timeout,\n      });\n    } catch (error) {\n      if (\n        (error as Error).message.includes(\"ERR_TIMED_OUT\") ||\n        (error as Error).message.includes(\"ERR_NETWORK_CHANGED\") ||\n        (error as Error).message.includes(\"ERR_SOCKET_NOT_CONNECTED\") ||\n        (error as PuppeteerError).name === \"TimeoutError\"\n      ) {\n        throw new PageLoadError(408, (error as Error).message);\n      }\n      throw error;\n    }\n\n    await new Promise((resolve) => {\n      setTimeout(resolve, waitFor);\n    });\n\n    const content = await page.content();\n    if (response!.status() !== 200) {\n      throw new PageLoadError(response!.status(), \"Page failed to load\");\n    }\n\n    const finalUrl = response!.url();\n\n    logger.info(\n      {\n        finalUrl,\n      },\n      \"Page loaded successfully\",\n    );\n\n    if (convertToMd) {\n      return { content: turndown.turndown(content), url: finalUrl };\n    }\n\n    return { content, url: finalUrl };\n  };\n\n  let count = 0;\n  while (count < 3) {\n    try {\n      return await visitPage();\n    } catch (error) {\n      if (\n        error instanceof PageLoadError &&\n        (error.status === 408 ||\n          error.status === 401 ||\n          error.status === 403 ||\n          error.status === 429)\n      ) {\n        count++;\n        const ms = Math.pow(2, count - 1) * 30_000;\n        logger.warn(\n          {\n            url,\n            status: error.status,\n          },\n          `[Scrapper] Retrying page.goto in ${Math.round(ms / 1000)} seconds`,\n        );\n        await sleep(ms);\n        continue;\n      }\n      throw error;\n    }\n  }\n\n  throw new PageLoadError(408, \"Page failed to load\");\n}\n\nexport async function scrapeUrls(params: {\n  urls: string[];\n  waitFor?: number;\n  timeout?: number;\n  convertToMd?: boolean;\n  useProxy?: boolean;\n  onPoll?: () => void;\n}): Promise<\n  {\n    url: string;\n    content?: string;\n    error?: Error;\n  }[]\n> {\n  const {\n    urls,\n    waitFor = 2000,\n    timeout = 180_000,\n    convertToMd = true,\n    useProxy = true,\n  } = params;\n\n  const { browser, context } = await newBrowserContext({\n    useProxy,\n  });\n\n  const { pages } = await newBrowserPages({\n    pages: urls.length,\n    context,\n  });\n\n  const results = await Promise.allSettled(\n    pages.map(async (page, index) => {\n      const { content, url } = await scrapeUrl({\n        url: urls[index],\n        page,\n        timeout,\n        waitFor,\n        convertToMd,\n      });\n      return { content, url };\n    }),\n  );\n\n  await browser.close();\n\n  return results.map((result, index) => {\n    if (result.status === \"fulfilled\") {\n      return result.value;\n    }\n    return {\n      url: urls[index],\n      error: result.reason as Error,\n    };\n  });\n}\n"]}